{"version":3,"sources":["../src/next-middleware.ts"],"sourcesContent":["import { validateRsc, type RscGuardOptions } from \"./rsc\";\n\nexport interface NextMiddlewareGuardOptions extends RscGuardOptions {\n  /**\n   * If action === \"block\", which status to return.\n   * Default: 404\n   */\n  blockStatus?: number;\n\n  /**\n   * If true, add a small debug header (reason/action) on rewritten/blocked responses.\n   * Default: false\n   */\n  debugHeaders?: boolean;\n}\n\n/**\n * Guards a Next.js middleware request.\n *\n * Returns:\n * - undefined if request should proceed\n * - a Response (rewrite or block) if action is needed\n *\n * NOTE: We intentionally do not import NextResponse directly in the core package build.\n * Users will call this from middleware and pass NextResponse in helper below,\n * or use withRscGuard which lazily imports next/server at runtime.\n */\nexport async function guardNextMiddleware(\n  req: { nextUrl: URL; headers: Headers },\n  opts?: NextMiddlewareGuardOptions\n): Promise<Response | undefined> {\n  const blockStatus = opts?.blockStatus ?? 404;\n  const res = validateRsc(req.nextUrl.toString(), req.headers, opts);\n\n  if (res.action === \"pass\") return undefined;\n\n  // For \"block\" we return an empty response with status\n  if (res.action === \"block\") {\n    const out = new Response(null, { status: blockStatus });\n    if (opts?.debugHeaders) {\n      out.headers.set(\"x-next-rsc-guard-action\", \"block\");\n      if (res.reason) out.headers.set(\"x-next-rsc-guard-reason\", res.reason);\n    }\n    return out;\n  }\n\n  // For \"strip\" we rewrite to URL without _rsc\n  if (res.action === \"strip\" && res.strippedUrl) {\n    // We must use NextResponse.rewrite in real middleware.\n    // Here we return a marker response that withRscGuard will convert to NextResponse.rewrite.\n    const out = new Response(null, { status: 204 });\n    out.headers.set(\"x-next-rsc-guard-rewrite\", res.strippedUrl);\n    if (opts?.debugHeaders) {\n      out.headers.set(\"x-next-rsc-guard-action\", \"strip\");\n      if (res.reason) out.headers.set(\"x-next-rsc-guard-reason\", res.reason);\n    }\n    return out;\n  }\n\n  return undefined;\n}\n\n/**\n * Middleware wrapper that:\n * - runs the guard\n * - if guard indicates rewrite, uses NextResponse.rewrite\n * - otherwise runs your handler\n */\nexport function withRscGuard(\n  handler: (req: any) => Response | Promise<Response>,\n  opts?: NextMiddlewareGuardOptions\n) {\n  return async (req: any) => {\n    const maybe = await guardNextMiddleware(req, opts);\n    if (!maybe) return handler(req);\n\n    const rewriteTo = maybe.headers.get(\"x-next-rsc-guard-rewrite\");\n    if (!rewriteTo) return maybe;\n\n    // Lazy import to keep this entrypoint working only when used in Next projects\n    const { NextResponse } = await import(\"next/server\");\n\n    const url = req.nextUrl.clone();\n    const rewritten = new URL(rewriteTo, \"http://localhost\");\n    url.search = rewritten.search; // keep params sans _rsc\n    url.hash = rewritten.hash;\n\n    const out = NextResponse.rewrite(url);\n\n    // propagate debug headers if enabled\n    const action = maybe.headers.get(\"x-next-rsc-guard-action\");\n    const reason = maybe.headers.get(\"x-next-rsc-guard-reason\");\n    if (action) out.headers.set(\"x-next-rsc-guard-action\", action);\n    if (reason) out.headers.set(\"x-next-rsc-guard-reason\", reason);\n\n    return out;\n  };\n}\n"],"mappings":";;;;;AA2BA,eAAsB,oBACpB,KACA,MAC+B;AAC/B,QAAM,cAAc,MAAM,eAAe;AACzC,QAAM,MAAM,YAAY,IAAI,QAAQ,SAAS,GAAG,IAAI,SAAS,IAAI;AAEjE,MAAI,IAAI,WAAW,OAAQ,QAAO;AAGlC,MAAI,IAAI,WAAW,SAAS;AAC1B,UAAM,MAAM,IAAI,SAAS,MAAM,EAAE,QAAQ,YAAY,CAAC;AACtD,QAAI,MAAM,cAAc;AACtB,UAAI,QAAQ,IAAI,2BAA2B,OAAO;AAClD,UAAI,IAAI,OAAQ,KAAI,QAAQ,IAAI,2BAA2B,IAAI,MAAM;AAAA,IACvE;AACA,WAAO;AAAA,EACT;AAGA,MAAI,IAAI,WAAW,WAAW,IAAI,aAAa;AAG7C,UAAM,MAAM,IAAI,SAAS,MAAM,EAAE,QAAQ,IAAI,CAAC;AAC9C,QAAI,QAAQ,IAAI,4BAA4B,IAAI,WAAW;AAC3D,QAAI,MAAM,cAAc;AACtB,UAAI,QAAQ,IAAI,2BAA2B,OAAO;AAClD,UAAI,IAAI,OAAQ,KAAI,QAAQ,IAAI,2BAA2B,IAAI,MAAM;AAAA,IACvE;AACA,WAAO;AAAA,EACT;AAEA,SAAO;AACT;AAQO,SAAS,aACd,SACA,MACA;AACA,SAAO,OAAO,QAAa;AACzB,UAAM,QAAQ,MAAM,oBAAoB,KAAK,IAAI;AACjD,QAAI,CAAC,MAAO,QAAO,QAAQ,GAAG;AAE9B,UAAM,YAAY,MAAM,QAAQ,IAAI,0BAA0B;AAC9D,QAAI,CAAC,UAAW,QAAO;AAGvB,UAAM,EAAE,aAAa,IAAI,MAAM,OAAO,aAAa;AAEnD,UAAM,MAAM,IAAI,QAAQ,MAAM;AAC9B,UAAM,YAAY,IAAI,IAAI,WAAW,kBAAkB;AACvD,QAAI,SAAS,UAAU;AACvB,QAAI,OAAO,UAAU;AAErB,UAAM,MAAM,aAAa,QAAQ,GAAG;AAGpC,UAAM,SAAS,MAAM,QAAQ,IAAI,yBAAyB;AAC1D,UAAM,SAAS,MAAM,QAAQ,IAAI,yBAAyB;AAC1D,QAAI,OAAQ,KAAI,QAAQ,IAAI,2BAA2B,MAAM;AAC7D,QAAI,OAAQ,KAAI,QAAQ,IAAI,2BAA2B,MAAM;AAE7D,WAAO;AAAA,EACT;AACF;","names":[]}