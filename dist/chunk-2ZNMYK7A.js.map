{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/**\n * next-rsc-guard (core)\n *\n * This library validates coherence of Next.js App Router RSC (_rsc) cache-busting param\n * with Flight request headers.\n *\n * Important:\n * - _rsc is NOT a security token in Next.js.\n * - This library provides pragmatic validation to mitigate bots / cache explosion.\n */\n\nexport type HeaderBag =\n  | Headers\n  | Record<string, string | undefined>\n  | Array<[string, string]>;\n\nfunction getHeader(headers: HeaderBag, name: string): string | undefined {\n  const key = name.toLowerCase();\n\n  if (typeof (headers as Headers).get === \"function\") {\n    return (headers as Headers).get(key) ?? undefined;\n  }\n\n  if (Array.isArray(headers)) {\n    const hit = headers.find(([k]) => k.toLowerCase() === key);\n    return hit?.[1];\n  }\n\n  const obj = headers as Record<string, string | undefined>;\n  return obj[name] ?? obj[key];\n}\n\n/**\n * Minimal heuristic:\n * - rsc: \"1\"\n * - next-router-state-tree present\n */\nexport function isFlightRequest(headers: HeaderBag): boolean {\n  const rsc = getHeader(headers, \"rsc\");\n  const routerState = getHeader(headers, \"next-router-state-tree\");\n  return rsc === \"1\" && !!routerState;\n}\n\n/**\n * Removes the internal Next.js cache-busting query param (_rsc by default).\n * Returns a relative URL (path + query + hash).\n */\nexport function stripRsc(inputUrl: string, paramName = \"_rsc\"): string {\n  const url = new URL(inputUrl, \"http://localhost\");\n  url.searchParams.delete(paramName);\n\n  return (\n    url.pathname +\n    (url.search ? url.search : \"\") +\n    (url.hash ? url.hash : \"\")\n  );\n}\n\n/**\n * Next.js uses a short non-cryptographic hash for cache-busting.\n * In the canary you inspected: djb2 32-bit -> base36 -> slice(0,5).\n */\nfunction djb2Hash(str: string): number {\n  let hash = 5381;\n  for (let i = 0; i < str.length; i++) {\n    hash = ((hash << 5) + hash) ^ str.charCodeAt(i);\n  }\n  return hash >>> 0;\n}\n\nfunction nextHexHash(str: string): string {\n  return djb2Hash(str).toString(36).slice(0, 5);\n}\n\nexport type RscGuardAction = \"pass\" | \"strip\" | \"block\";\n\nexport interface RscGuardOptions {\n  rscQueryParam?: string; // default \"_rsc\"\n  rscHeader?: string; // default \"rsc\"\n  routerStateTreeHeader?: string; // default \"next-router-state-tree\"\n  routerPrefetchHeader?: string; // default \"next-router-prefetch\"\n  segmentPrefetchHeader?: string; // default \"next-router-segment-prefetch\"\n  nextUrlHeader?: string; // default \"next-url\"\n\n  /**\n   * If true, require Accept includes \"text/x-component\".\n   * Default false to avoid regressions across versions/runtimes.\n   */\n  requireAcceptRsc?: boolean;\n\n  /**\n   * Action if _rsc is present but request is not Flight.\n   * Default: \"strip\" (safe for cache, low false positives).\n   */\n  onNonFlightWithRsc?: RscGuardAction;\n\n  /**\n   * Action if request is Flight but _rsc mismatches expected.\n   * Default: \"strip\".\n   */\n  onMismatch?: RscGuardAction;\n}\n\nexport interface RscValidationResult {\n  hasRscParam: boolean;\n  isFlight: boolean;\n  expectedRsc?: string;\n  providedRsc?: string;\n  ok: boolean;\n  action: RscGuardAction;\n  reason?: string;\n  strippedUrl?: string;\n}\n\nfunction normalizeOptions(opts?: RscGuardOptions) {\n  return {\n    rscQueryParam: \"_rsc\",\n    rscHeader: \"rsc\",\n    routerStateTreeHeader: \"next-router-state-tree\",\n    routerPrefetchHeader: \"next-router-prefetch\",\n    segmentPrefetchHeader: \"next-router-segment-prefetch\",\n    nextUrlHeader: \"next-url\",\n    requireAcceptRsc: false,\n    onNonFlightWithRsc: \"strip\" as const,\n    onMismatch: \"strip\" as const,\n    ...opts,\n  };\n}\n\n/**\n * Compute the expected _rsc value from headers, mirroring Next's computeCacheBustingSearchParam:\n * hash of: [prefetch, segmentPrefetch, stateTree, nextUrl].join(',')\n *\n * If the input signals are empty, returns '' (cannot compute reliably).\n */\nexport function computeExpectedRsc(headers: HeaderBag, opts?: RscGuardOptions): string {\n  const o = normalizeOptions(opts);\n\n  const prefetch = getHeader(headers, o.routerPrefetchHeader) ?? \"\";\n  const segmentPrefetch = getHeader(headers, o.segmentPrefetchHeader) ?? \"\";\n  const stateTree = getHeader(headers, o.routerStateTreeHeader) ?? \"\";\n  const nextUrl = getHeader(headers, o.nextUrlHeader) ?? \"\";\n\n  const raw = [prefetch, segmentPrefetch, stateTree, nextUrl].join(\",\");\n\n  if (!raw || raw === \",,,\") return \"\";\n  return nextHexHash(raw);\n}\n\n/**\n * Validates coherence of _rsc with Flight headers.\n *\n * - If _rsc is absent: pass\n * - If _rsc present but not Flight: strip/block (configurable)\n * - If Flight: compute expected and compare with provided (if present)\n */\nexport function validateRsc(\n  inputUrl: string,\n  headers: HeaderBag,\n  opts?: RscGuardOptions\n): RscValidationResult {\n  const o = normalizeOptions(opts);\n\n  const url = new URL(inputUrl, \"http://localhost\");\n  const hasRscParam = url.searchParams.has(o.rscQueryParam);\n  const providedRsc = url.searchParams.get(o.rscQueryParam) ?? undefined;\n\n  // No _rsc => nothing to do\n  if (!hasRscParam) {\n    return { hasRscParam, isFlight: false, ok: true, action: \"pass\" };\n  }\n\n  // Determine Flight-ness (optionally require accept)\n  const isFlight = (() => {\n    const rsc = getHeader(headers, o.rscHeader);\n    const tree = getHeader(headers, o.routerStateTreeHeader);\n    if (rsc !== \"1\" || !tree) return false;\n\n    if (o.requireAcceptRsc) {\n      const accept = getHeader(headers, \"accept\");\n      if (!accept || !accept.toLowerCase().includes(\"text/x-component\")) return false;\n    }\n    return true;\n  })();\n\n  // _rsc present but not Flight\n  if (!isFlight) {\n    const action = o.onNonFlightWithRsc;\n    return {\n      hasRscParam,\n      isFlight,\n      providedRsc,\n      ok: action !== \"block\",\n      action,\n      reason: \"rsc_query_present_but_not_flight_request\",\n      strippedUrl: action === \"strip\" ? stripRsc(inputUrl, o.rscQueryParam) : undefined,\n    };\n  }\n\n  // Flight request: compute expected\n  const expectedRsc = computeExpectedRsc(headers, o);\n\n  // If we cannot compute expected (headers incomplete), do not block by default (compatibility).\n  if (!expectedRsc) {\n    return {\n      hasRscParam,\n      isFlight,\n      providedRsc,\n      expectedRsc,\n      ok: true,\n      action: \"pass\",\n      reason: \"flight_request_but_expected_rsc_empty\",\n    };\n  }\n\n  // If param exists but has no value -> treat as mismatch (configurable)\n  if (!providedRsc) {\n    const action = o.onMismatch;\n    return {\n      hasRscParam,\n      isFlight,\n      providedRsc,\n      expectedRsc,\n      ok: action !== \"block\",\n      action,\n      reason: \"flight_request_missing_rsc_value\",\n      strippedUrl: action === \"strip\" ? stripRsc(inputUrl, o.rscQueryParam) : undefined,\n    };\n  }\n\n  // Compare\n  if (providedRsc === expectedRsc) {\n    return {\n      hasRscParam,\n      isFlight,\n      providedRsc,\n      expectedRsc,\n      ok: true,\n      action: \"pass\",\n    };\n  }\n\n  const action = o.onMismatch;\n  return {\n    hasRscParam,\n    isFlight,\n    providedRsc,\n    expectedRsc,\n    ok: action !== \"block\",\n    action,\n    reason: \"flight_request_rsc_mismatch\",\n    strippedUrl: action === \"strip\" ? stripRsc(inputUrl, o.rscQueryParam) : undefined,\n  };\n}\n"],"mappings":"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","names":["action"]}