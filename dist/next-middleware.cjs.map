{"version":3,"sources":["../src/next-middleware.ts","../src/headers.ts","../src/hash.ts","../src/rsc.ts"],"sourcesContent":["import { validateRsc, type RscGuardOptions } from \"./rsc\";\n\nexport interface NextMiddlewareGuardOptions extends RscGuardOptions {\n  /**\n   * If action === \"block\", which status to return.\n   * Default: 404\n   */\n  blockStatus?: number;\n\n  /**\n   * If true, add a small debug header (reason/action) on rewritten/blocked responses.\n   * Default: false\n   */\n  debugHeaders?: boolean;\n}\n\n/**\n * Guards a Next.js middleware request.\n *\n * Returns:\n * - undefined if request should proceed\n * - a Response (rewrite or block) if action is needed\n *\n * NOTE: We intentionally do not import NextResponse directly in the core package build.\n * Users will call this from middleware and pass NextResponse in helper below,\n * or use withRscGuard which lazily imports next/server at runtime.\n */\nexport async function guardNextMiddleware(\n  req: { nextUrl: URL; headers: Headers },\n  opts?: NextMiddlewareGuardOptions\n): Promise<Response | undefined> {\n  const blockStatus = opts?.blockStatus ?? 404;\n  const res = validateRsc(req.nextUrl.toString(), req.headers, opts);\n\n  if (res.action === \"pass\") return undefined;\n\n  // For \"block\" we return an empty response with status\n  if (res.action === \"block\") {\n    const out = new Response(null, { status: blockStatus });\n    if (opts?.debugHeaders) {\n      out.headers.set(\"x-next-rsc-guard-action\", \"block\");\n      if (res.reason) out.headers.set(\"x-next-rsc-guard-reason\", res.reason);\n    }\n    return out;\n  }\n\n  // For \"strip\" we rewrite to URL without _rsc\n  if (res.action === \"strip\" && res.strippedUrl) {\n    // We must use NextResponse.rewrite in real middleware.\n    // Here we return a marker response that withRscGuard will convert to NextResponse.rewrite.\n    const out = new Response(null, { status: 204 });\n    out.headers.set(\"x-next-rsc-guard-rewrite\", res.strippedUrl);\n    if (opts?.debugHeaders) {\n      out.headers.set(\"x-next-rsc-guard-action\", \"strip\");\n      if (res.reason) out.headers.set(\"x-next-rsc-guard-reason\", res.reason);\n    }\n    return out;\n  }\n\n  return undefined;\n}\n\n/**\n * Middleware wrapper that:\n * - runs the guard\n * - if guard indicates rewrite, uses NextResponse.rewrite\n * - otherwise runs your handler\n */\nexport function withRscGuard(\n  handler: (req: any) => Response | Promise<Response>,\n  opts?: NextMiddlewareGuardOptions\n) {\n  return async (req: any) => {\n    const maybe = await guardNextMiddleware(req, opts);\n    if (!maybe) return handler(req);\n\n    const rewriteTo = maybe.headers.get(\"x-next-rsc-guard-rewrite\");\n    if (!rewriteTo) return maybe;\n\n    // Lazy import to keep this entrypoint working only when used in Next projects\n    const { NextResponse } = await import(\"next/server\");\n\n    const url = req.nextUrl.clone();\n    const rewritten = new URL(rewriteTo, \"http://localhost\");\n    url.search = rewritten.search; // keep params sans _rsc\n    url.hash = rewritten.hash;\n\n    const out = NextResponse.rewrite(url);\n\n    // propagate debug headers if enabled\n    const action = maybe.headers.get(\"x-next-rsc-guard-action\");\n    const reason = maybe.headers.get(\"x-next-rsc-guard-reason\");\n    if (action) out.headers.set(\"x-next-rsc-guard-action\", action);\n    if (reason) out.headers.set(\"x-next-rsc-guard-reason\", reason);\n\n    return out;\n  };\n}\n","export type HeaderBag =\n  | Headers\n  | Record<string, string | undefined>\n  | Array<[string, string]>;\n\nexport function getHeader(\n  headers: HeaderBag,\n  name: string\n): string | undefined {\n  const key = name.toLowerCase();\n\n  if (typeof (headers as Headers).get === \"function\") {\n    return (headers as Headers).get(key) ?? undefined;\n  }\n\n  if (Array.isArray(headers)) {\n    const hit = headers.find(([k]) => k.toLowerCase() === key);\n    return hit?.[1];\n  }\n\n  const obj = headers as Record<string, string | undefined>;\n  return obj[name] ?? obj[key];\n}\n","/**\n * Next.js uses a short non-cryptographic hash for cache-busting.\n * Implementation mirrors: djb2 32-bit -> base36 -> slice(0,5).\n */\n\nexport function djb2Hash(str: string): number {\n  let hash = 5381;\n  for (let i = 0; i < str.length; i++) {\n    hash = ((hash << 5) + hash) ^ str.charCodeAt(i);\n  }\n  return hash >>> 0;\n}\n\nexport function nextHexHash(str: string): string {\n  return djb2Hash(str).toString(36).slice(0, 5);\n}\n","import type { HeaderBag } from \"./headers\";\nimport { getHeader } from \"./headers\";\nimport { nextHexHash } from \"./hash\";\n\nexport type RscGuardAction = \"pass\" | \"strip\" | \"block\";\n\nexport interface RscGuardOptions {\n  rscQueryParam?: string; // default \"_rsc\"\n  rscHeader?: string; // default \"rsc\"\n  routerStateTreeHeader?: string; // default \"next-router-state-tree\"\n  routerPrefetchHeader?: string; // default \"next-router-prefetch\"\n  segmentPrefetchHeader?: string; // default \"next-router-segment-prefetch\"\n  nextUrlHeader?: string; // default \"next-url\"\n\n  /**\n   * If true, require Accept includes \"text/x-component\".\n   * Default false to avoid regressions across versions/runtimes.\n   */\n  requireAcceptRsc?: boolean;\n\n  /**\n   * Action if _rsc is present but request is not Flight.\n   * Default: \"strip\" (safe for cache, low false positives).\n   */\n  onNonFlightWithRsc?: RscGuardAction;\n\n  /**\n   * Action if request is Flight but _rsc mismatches expected.\n   * Default: \"strip\".\n   */\n  onMismatch?: RscGuardAction;\n}\n\nexport interface RscValidationResult {\n  hasRscParam: boolean;\n  isFlight: boolean;\n  expectedRsc?: string;\n  providedRsc?: string;\n  ok: boolean;\n  action: RscGuardAction;\n  reason?: string;\n  strippedUrl?: string;\n}\n\nfunction normalizeOptions(opts?: RscGuardOptions) {\n  return {\n    rscQueryParam: \"_rsc\",\n    rscHeader: \"rsc\",\n    routerStateTreeHeader: \"next-router-state-tree\",\n    routerPrefetchHeader: \"next-router-prefetch\",\n    segmentPrefetchHeader: \"next-router-segment-prefetch\",\n    nextUrlHeader: \"next-url\",\n    requireAcceptRsc: false,\n    onNonFlightWithRsc: \"strip\" as const,\n    onMismatch: \"strip\" as const,\n    ...opts,\n  };\n}\n\n/**\n * Minimal heuristic:\n * - rsc: \"1\"\n * - next-router-state-tree present\n */\nexport function isFlightRequest(headers: HeaderBag): boolean {\n  const rsc = getHeader(headers, \"rsc\");\n  const routerState = getHeader(headers, \"next-router-state-tree\");\n  return rsc === \"1\" && !!routerState;\n}\n\n/**\n * Removes the internal Next.js cache-busting query param (_rsc by default).\n * Returns a relative URL (path + query + hash).\n */\nexport function stripRsc(inputUrl: string, paramName = \"_rsc\"): string {\n  const url = new URL(inputUrl, \"http://localhost\");\n  url.searchParams.delete(paramName);\n\n  return (\n    url.pathname + (url.search ? url.search : \"\") + (url.hash ? url.hash : \"\")\n  );\n}\n\n/**\n * Compute expected _rsc from headers, mirroring Next's computeCacheBustingSearchParam:\n * hash of: [prefetch, segmentPrefetch, stateTree, nextUrl].join(',')\n *\n * If the input signals are empty, returns '' (cannot compute reliably).\n */\nexport function computeExpectedRsc(\n  headers: HeaderBag,\n  opts?: RscGuardOptions\n): string {\n  const o = normalizeOptions(opts);\n\n  const prefetch = getHeader(headers, o.routerPrefetchHeader) ?? \"\";\n  const segmentPrefetch = getHeader(headers, o.segmentPrefetchHeader) ?? \"\";\n  const stateTree = getHeader(headers, o.routerStateTreeHeader) ?? \"\";\n  const nextUrl = getHeader(headers, o.nextUrlHeader) ?? \"\";\n\n  const raw = [prefetch, segmentPrefetch, stateTree, nextUrl].join(\",\");\n\n  if (!raw || raw === \",,,\") return \"\";\n  return nextHexHash(raw);\n}\n\n/**\n * Validates coherence of _rsc with Flight headers.\n *\n * - If _rsc is absent: pass\n * - If _rsc present but not Flight: strip/block (configurable)\n * - If Flight: compute expected and compare with provided (if present)\n */\nexport function validateRsc(\n  inputUrl: string,\n  headers: HeaderBag,\n  opts?: RscGuardOptions\n): RscValidationResult {\n  const o = normalizeOptions(opts);\n\n  const url = new URL(inputUrl, \"http://localhost\");\n  const hasRscParam = url.searchParams.has(o.rscQueryParam);\n  const providedRsc = url.searchParams.get(o.rscQueryParam) ?? undefined;\n\n  if (!hasRscParam) {\n    return { hasRscParam, isFlight: false, ok: true, action: \"pass\" };\n  }\n\n  const isFlight = (() => {\n    const rsc = getHeader(headers, o.rscHeader);\n    const tree = getHeader(headers, o.routerStateTreeHeader);\n    if (rsc !== \"1\" || !tree) return false;\n\n    if (o.requireAcceptRsc) {\n      const accept = getHeader(headers, \"accept\");\n      if (!accept || !accept.toLowerCase().includes(\"text/x-component\"))\n        return false;\n    }\n\n    return true;\n  })();\n\n  if (!isFlight) {\n    const action = o.onNonFlightWithRsc;\n    return {\n      hasRscParam,\n      isFlight,\n      providedRsc,\n      ok: action !== \"block\",\n      action,\n      reason: \"rsc_query_present_but_not_flight_request\",\n      strippedUrl:\n        action === \"strip\" ? stripRsc(inputUrl, o.rscQueryParam) : undefined,\n    };\n  }\n\n  const expectedRsc = computeExpectedRsc(headers, o);\n\n  if (!expectedRsc) {\n    return {\n      hasRscParam,\n      isFlight,\n      providedRsc,\n      expectedRsc,\n      ok: true,\n      action: \"pass\",\n      reason: \"flight_request_but_expected_rsc_empty\",\n    };\n  }\n\n  if (!providedRsc) {\n    const action = o.onMismatch;\n    return {\n      hasRscParam,\n      isFlight,\n      providedRsc,\n      expectedRsc,\n      ok: action !== \"block\",\n      action,\n      reason: \"flight_request_missing_rsc_value\",\n      strippedUrl:\n        action === \"strip\" ? stripRsc(inputUrl, o.rscQueryParam) : undefined,\n    };\n  }\n\n  if (providedRsc === expectedRsc) {\n    return {\n      hasRscParam,\n      isFlight,\n      providedRsc,\n      expectedRsc,\n      ok: true,\n      action: \"pass\",\n    };\n  }\n\n  const action = o.onMismatch;\n  return {\n    hasRscParam,\n    isFlight,\n    providedRsc,\n    expectedRsc,\n    ok: action !== \"block\",\n    action,\n    reason: \"flight_request_rsc_mismatch\",\n    strippedUrl:\n      action === \"strip\" ? stripRsc(inputUrl, o.rscQueryParam) : undefined,\n  };\n}\n"],"mappings":"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","names":["action"]}